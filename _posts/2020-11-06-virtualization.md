---
layout: post
title: Что такое виртуализация
subtitle: В чем суть этой технологии, история возникновения и какие бывают виды виртуализации.
summary: Виртуализация — это создание изолированных окружений в рамках одного физического компьютера. 
cover_url: "/images/virtualization/virtualization_cover.jpg"
---

Сегодняшние компьютеры обладают очень широкими возможностями, но изначально они создавались для установки только одной операционной системы. Далее мы узнаем как виртуализация сделала возможным запуск десятков ОС на одном физическом устройстве во много раз повысив эффективность использования оборудования и в значительной степени повлияв на развитие информационных технологий.

В современном мире даже у обычных пользователей Linux или Mac иногда возникает потребность в запуске программ, работающих только в Windows, а у Windows-пользователей, особенно программистов, потребность в запуске Linux или другой версии Windows. Классический пример — игры или Photoshop.

Самый очевидный способ сделать это — купить второй компьютер, но это дорогое удовольствие. Второй вариант — поставить Windows рядом со своей основной операционной системой. Такая установка, как правило, может все сломать, но если у вас получилось, во время старта компьютера вы сможете выбрать операционную систему для загрузки. Но существует третий путь — **виртуализация**.

## Виртуализация

Виртуализация позволяет предоставлять вычислительные ресурсы, а если говорить точнее, то их логическое объединение, которое не зависит от физической (аппаратной) реализации. При этом обеспечивая изоляцию нескольких одновременно выполняемых вычислительных процессов. По сути это и есть определение виртуализации.

### История 

#### Переключение между задачами

Предвестником появления виртуализации по праву может считаться [концепция разделения времени](https://en.wikipedia.org/wiki/Time-sharing) появившаяся в начале 60-x годов 20 столетия. Она предполагала разделение вычислительных ресурсов одной ЭВМ между множеством пользователей. Таким образом, пока один пользователь вводил данные, машина могла производить вычисления. Ей не нужно было простаивать и ждать, пока следующий программист настроит её работу. Такой подход с последовательной обработкой данных вводимых несколькими пользователями оказался намного эффективнее, чем так называется "индивидуальная работа".

Представьте насколько медленными были ЭВМ, что реализация данной концепции была буквальной. В то время, как один программист думал и вводил данные в машину, она обрабатывала задачи другого пользователя.

С ростом производительности оборудования переключение между задачами становилось быстрее. Для каждой из задач выделялось чётко опредленное количество времени, называемое "квантом", на протяжении которого ЭВМ занималась её обработкой. Далее процесс прекращался, текущее состояние задачи сохранялось и осуществлялся переход к следующей и так далее. Эта схема легла в основу важнейшего на сегодняшний день процесса [переключения контекста](https://en.wikipedia.org/wiki/Context_switch) который в том или ином виде используется во всех современных операционных системах.

#### Первая виртуализация

В 1968 году появилась первая операционная система с поддержкой виртуализации — [CP/CMS](https://en.wikipedia.org/wiki/CP/CMS). Она была разработана Кембриджскими учёными для мейнфрейма компании IBM. Отличительной особенностью CP/CMS было то, что в её основе лежал монитор виртуальных машин или, как его еще называют, [гипервизор](https://en.wikipedia.org/wiki/Hypervisor). Который обеспечивал одновременное параллельное выполнение и изоляцию на одном и том же компьютере нескольких операционных систем.

Преимущества такого подхода были огромны:

* С помощью гипервизора можно было создавать столько виртуальных машин, сколько требовалось, чтобы покрыть производительность оборудования и минимизировать перерывы в работе между пользователями
* Первые гипервизоры создавали точную копию исходных устройств внутри виртуальной машины, таким образом позволяя запускать любую ОС, которая поддерживала эти устройства. Появилась возможность запускать разные ОС одновременно.
* Эффективность использования ресурсов возросла в разы. Так как они использовались всеми виртуальными машинами совместно.
* Благодаря изоляции операционных систем, выход из строя одной из них не оказывал никакого влияния на остальные виртуальные машины. Таким образом вся система становилась намного надёжнее.

![Terminal IBM 3270](/images/virtualization/ibm_3270_terminal.jpg)

ОС [VM/370](https://en.wikipedia.org/wiki/VM_(operating_system)) в основу которой легла CP/CMS поставлялась с популярным в те времена мейнфреймом [System/370](https://en.wikipedia.org/wiki/IBM_System/370). Для него поставлялись специальные терминалы, которые уже напоминали современные компьютеры. Вот только это по сути были экран и клавиатура подключенные к огромному мейнфрейму. Поддерживалась одновременная работа с десятками и даже сотнями таких устройств.

#### Второй рассвет технологии

С удешевлением персональных компьютеров в 1990-х годах технологии виртуализации отошли на второй план. Организациям стало выгодней обеспечить каждого сотрудника компьютером, чем оплачивать аренду, либо покупать себе дорогостоящий мейнфрейм.

Но высокий темп развития технологий привел к тому, что хоть операционные системы и стали намного более функциональными, надежность их резко упала. Критическая ошибка в одном приложении могла привести к выходу из строя всей ОС. Это привело к тому, что под одно важное приложение стали выделять отдельный компьютер. Например СУБД в организации, межсетевой экран или прокси-сервер, чтобы поломка одного из них полностью не парализовывала работу всей компании.

При таком подходе закономерно росли и расходы на оборудование. Тогда специалисты вновь вспомнили о виртуализации и стали разворачивать на одном физическом компьютере сразу несколько ОС и уже внутри виртуальных машин запускать нужные приложения.

Еще один огромный толчок в развитии технологии обусловил рост сети Интернет. Виртуализация и сделала возможным дешёвую аренду серверных ресурсов у хостинг провайдеров. А так как виртуализация не стояла на месте, производительность виртуальных серверов довольно стала очень близкой к выделенным.

![vmware esx](/images/virtualization/vmware_esx.png)

Особый вклад в развитие технологии внесла компания [VMWare](https://en.wikipedia.org/wiki/VMware), которая в начале 2000-х быстро захватила корпоративный рынок, выпустив автономный гипервизор [ESX Server](https://en.wikipedia.org/wiki/VMware_ESXi). Таким образом появилась конкурентная среда и вслед за VMWare на рынок вышли другие игроки.

### Терминалогия

Давайте разберемся с терминами которые используются, когда мы говорим о виртуализации. 

Определение виртуализации мы уже рассмотрели выше и поняли, что с помощью этой технологии можно запускать операционную систему, как обычную программу внутри другой операционной системы. Данная возможно обеспечивается с помощью **гипервизора**.

Гипервизор — это специальная программа (на самом деле гипервизоры бывают и в виде аппаратных схем), которая обеспечивает параллельное выполнение нескольких операционных систем. Гипервизор обеспечивает изоляцию операционных систем друг от друга, защиту и безопасность, а также разделение ресурсов между запущенными ОС.

Операционная система или компьютер внутри которой запускается виртуальная машина называется — **хост-системой** (host), а ОС работающая в виртуальном окружении называют — **гостевой** (guest).

![hypervisor types](/images/virtualization/hypervisor_types.jpg)

Гипервизоры, по большому счету, делятся на два типа: которые работают внутри операционной системы хоста и для запуска которых хостовая ОС не нужна. Последние умеют работать прямо на голом железе, так как гипервизор по сути и есть ОС для управления виртуальными машинами. На настольных компьютерах наибольшее распространение получил первый тип. 

В качестве примеров гипервизоров первого типа можно привести: VMware Workstation, QEMU и VirtualBox. А к второму типу относится упомянутый выше автономный гипервизор VMware ESX.

### Какие бывают виды виртуализации

Виртуализацию принято разделять на три вида, в зависимости от подхода к её реализации: 

**Программная виртуализация**, которая в свою очередь также подразделяется на несколько видов. В этом гайде мы не будем подробно рассматривать каждый из них, так как в настоящее время программная виртуализация используется не так широко из-за проблем с быстродействием. Если интересно, то подробнее можно почитать в [Википедии](https://ru.wikipedia.org/wiki/%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F). 
**Аппаратная виртуализация**. Для её работы требуется поддержка со стороны процессора. Наибольшее распространение получили технологии [Intel-VT](https://ru.wikipedia.org/wiki/%D0%90%D0%BF%D0%BF%D0%B0%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F_%D0%B2%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F#VT-d) и [AMD-V](https://en.wikipedia.org/wiki/X86_virtualization#AMD_virtualization_(AMD-V)), в настоящее время большинство процессоров для домашних компьютеров поддерживают одну из них. 

Аппаратная виртуализация не получила бы такого широкого распространения, если бы не преимущества, которые обеспечивает данный подход:

* Так как в данном варианте гипервизор работает в одном [кольце](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BB%D1%8C%D1%86%D0%B0_%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D1%8B) с ядром хостовой операционной системы — кольце 0, это значительно повышает производительность гостевых ОС и позволяет достичь эффективности сравнимой с невиртуализируемой машиной.
* Можно использовать немодифицированные дистрибутивы гостевых операционных систем, так как аппаратная виртуализация обеспечивает независимость от платформы хоста. Таким образом появляется возможность запуска 64-битных операционных систем на 32-битных хостах.
* Каждая гостевая операционная система работает независимо, в своём собственном аппаратном окружении, набор устройств для каждой ОС эмулируется абсолютно независимо. Это еще один фактор который позволяет сократить потери быстродействия и закономерно, за счет изоляции, увеличивает защищенность гостевых операционных систем.

Третий вид виртуализации называется — **Контейнеризация** или **Контейнерная виртуализация**. Это виртуализация на уровне операционной системы. Тогда как аппаратная виртуализация полностью эмулирует оборудование и позволяет запускать любых ОС, внутри контейнера можно запустить экземпляр операционной системы только с тем же ядром, как и у ОС хоста. Преимуществом этого подхода является уменьшение оверхеда (overhead, накладные расходы) на эмуляцию оборудования в сравнении с аппаратной виртуализацией.

На текущий момент такой вид виртуализации существует только в Linux и доступен благодаря двум возможностям ядра: cgroups и namespaces. Они позволяют запускать всего лишь один процесс так, как будто он выполняется в своем собственном мире, со своей сетью, своим диском, своей файловой системой и так далее. Эту виртуализацию применяют на уровне сервисов, составляющих части программного продукта. Наиболее известные проекты: OpenVZ, Docker, LXC.

Так как Docker очень широко применятся в разработке у нас есть подробный гайд о том, что это такое, как с ним работать и какие он даёт преимущества — [Как и для чего использовать Docker](https://guides.hexlet.io/docker/).

### Свойства виртуальных машин

Рассмотрим свойства виртуальных машин, которые обеспечивают преимущества от их использования.

* Разбиение — возможность запуска нескольких ОС на одном физическом хосте. 
* Изоляция на аппаратном уровне всех возможных неисправностей. Также изоляция позволяет сохранять быстродействие гостевых операционных систем за счет гибкого управления ресурсами. Стало не хватать оперативной памяти, расширяем её за счет хоста и производительность возрастает.
* Инкапсуляция. Возможность сохранения стейта (state, состояние) в виде обычных файлов. Это позволяет делать полные резервные копии виртуальных машин: жесткий диск, оперативная память, конфигурация оборудования. В случае выхода из строя гостевой ОС или даже хост-компьютера можно быстро развернуть виртуальную машину на другом оборудовании и она продолжит работу с момента, когда был сделан бекап.
* Независимость от оборудования. Данный пункт в большей степени относится к аппаратной виртуализации. Виртуальную машину можно переносить на любой сервер, где установлен соответствующий гипервизор и не важно какая у него архитектура.

### Решаемые задачи и области применения виртуализации

О виртуализации на домашнем комьютере и запуске в Linux программ написанных для Windows мы уже упоминали в самом начале статьи. Давайте рассмотрим другие сферы применения.

Виртуальные машины подходят для решения огромного количества различных задач и используются повсеместно.

Свойство изоляции виртуальных машин очень широко эксплуатируется в предоставлении веб-хостинга. Увеличение эффективности использования аппаратных ресурсов и последовавшее за этим удешевление услуг во многом обусловило и еще сильнее ускорило стремительный рост сети интернет.

Фактически для каждого пользователя создается своя собственная виртуальная машина с квотами, соответствующими выбранному тарифу (ограничения по памяти, процессору и так далее).

Кроме того, виртуализация изолирует машины друг от друга, а значит вам не придется переживать, если пользователи попытаются навредить системе или соседним пользователям. Подобная услуга обычно называется VPS (virtual private server) и в базовой комплектации стоит дешево.

Стоит сказать, что на VPS можно размещать не только сайты, но и почтовые серверы, CRM, VPN-серверы и многое другое.

Необычное использование виртуализации предоставляют сервисы, где пользователь может арендовать ресурсы сервера и запускать игры на устройствах, которые не удовлетворяют системным требованиям. Конечно потребуется очень хорошее интернет соединение, но даже о наличии такой возможности нельзя было и мечтать еще 10 лет назад. 

### Другие гайды по теме

1. [Как и для чего использовать Docker](https://guides.hexlet.io/docker/). Docker позволяет операционной системе запускать процессы в изолированном окружении на базе специально созданных образов.
2. [Что такое Vagrant](/vagrant). Vagrant позволяет создавать и конфигурировать легковесные, повторяемые и переносимые окружения для разработки в виртуальных машинах.
3. [Как работать с Linux используя Windows](/ubuntu-linux-in-windows). Инструкция по установке Ubuntu Linux внутри Windows с использованием различных технологий виртуализации.
